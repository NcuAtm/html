<div class="row-sm-1" id="showMoreChartWrapper">
    <button type="button" class="btn btn-info" data-toggle="modal" data-target="#showMoreChartModal" id="showMoreChartModalBtn" onclick="showMoreChart()">Show More Chart</button>
    <div class="modal fade" id="showMoreChartModal" tabindex="-1" role="dialog" aria-labelledby="showMoreChartModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document" style="max-width:1000px">
            <div class="modal-content" style="width:80vw;">
                <div class="modal-header">
                    <h5 class="modal-title" id="showMoreChartModalLongTitle">Show More Chart</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="col">
                        <div class="well">
                            <div id="ModalTempChart" class='my-chart modal-chart'></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="well">
                            <div id="ModalRhChart" class='my-chart modal-chart'></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="well">
                            <div id="ModalPmChart" class='my-chart modal-chart'></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="well">
                            <div id="ModalCo2Chart" class='my-chart modal-chart'></div>
                        </div>
                    </div>
                    <div class="col">
                        <div class="well">
                            <div id="ModalCoChart" class='my-chart modal-chart'></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function FetchData(w_id, time_format = 'epoch', amount = '30', variable = 'all', functionality = 'unit') {
        this.w_id = w_id;
        this.time_format = time_format;
        this.amount = amount;
        this.variable = variable;
        this.functionality = functionality;
        this.data = [];
        this.base_url = {
            'unit': '/data_api/latest_x_units/',
            'day': '/data_api/latest_x_days/',
            'time': '/data_api/time_sequence/'
        }

        this.get_url = function() {
            let base = this.base_url[this.functionality]
            let parameter = `?w_id=${this.w_id}&f=${this.time_format}&u=${this.amount}&variable=${this.variable}`;
            let url = base + parameter;
            return url;
        }

        this.fetch = function() {
            fetch(this.get_url()).then(response => response.json()).then(data => {
                this.data = data;
            }).catch(function(err) {
                console.log(`${this.url} Error`)
            })
        };
        this.fetch();
    }

    function FetchDataFactory() {
        this.list = [];
        this.create = function(w_id, time_format = 'epoch', amount = '30', variable = 'all', functionality = 'unit') {
            let fetch_data = new FetchData(w_id, time_format, amount, variable, functionality);
            this.list.push(fetch_data);
            return fetch_data;
        }
        this.fetch_all = function() {
            for (fetch_data of this.list){
                fetch_data.fetch();
            }
        }
    }

    function FetchDataLinearChart(fetch_data, dom, variable) {
        this.variable = variable;
        this.dom = dom;
        this.fetch_data = fetch_data;
        //this.fetch_data.variable = this.variable;
        this.chart = NaN;
        this.svg_dom = NaN;

        this.data_serialize = function(d, key, color) {
            let data = d;
            let tData = [];
            for (let datum of data) {
                tData.push({
                    x: datum['receive_time'],
                    y: parseFloat(datum[key])
                });
            };

            if (key == 'pm2_5') {
                key = 'pm2.5';
            };

            return [{
                values: tData,
                key: key,
                color: color
            }];
        };

        this.chart_init = function(d, yLabel, domainMax, domainMin) {
            chart = nv.models.lineChart()
                .options({
                    duration: 300,
                    useInteractiveGuideline: true
                });

            // chart sub-models (ie. xAxis, yAxis, etc) when accessed directly, return themselves, not the parent chart, so need to chain separately
            chart.xAxis
                .axisLabel('Time')
                .showMaxMin(false)
                .rotateLabels(-20) // Want longer labels? Try rotating them to fit easier.
                .tickPadding(10)
                .tickFormat(function(d) {
                    return d3.time.format('%m/%d %H')(new Date(d));
                })

            chart.yAxis
                .axisLabel(yLabel)
                .ticks(5)
                .tickFormat(function(d) {
                    if (d == null) {
                        return 'N/A';
                    };
                    return d3.format('4.2f')(d);
                });

            //chart.forceY([domainMin,domainMax])
            return chart;
        }

        this.plot = function(Jdata) {
            let variable = this.variable;
            let d = this.data_serialize(Jdata, variable, variableColor[variable]);
            let yLabel = variableUnit[variable];
            let domainMax = variableMax[variable];
            let domainMin = variableMin[variable];
            this.chart = this.chart_init(d, yLabel, domainMax, domainMin);
            this.svg_dom = d3.select(`${this.dom}`).append('svg');
            this.svg_dom.datum(d).transition().duration(500).call(this.chart);
            nv.utils.windowResize(this.chart.update);
        }

        this.dom_init = function() {
            if (this.fetch_data.data.length == 0) {
                this.data_update();
            }
            if ($(`${this.dom}`).length > 0) {
                this.remove_dom();
            }
            this.plot(this.fetch_data.data);
        }

        this.remove_dom = function() {
            d3.selectAll(`${this.dom} svg`).remove();
        }

        this.plot_update = function() {
            this.svg_dom.datum(
                    this.data_serialize(this.fetch_data.data, variable, variableColor[variable])
                )
                .transition().duration(500).call(this.chart);
        }

        this.data_update = function() {
            this.fetch_data.fetch();
        }
    }

    function FetchDataChartFactory() {
        this.chart_cate = {
            'linear': FetchDataLinearChart,
        }
        this.list = [];
        this.create = function(fetch_data, dom, variable, t = 'linear') {
            let fetch_data_chart = new this.chart_cate[t](fetch_data, dom, variable);
            this.list.push(fetch_data_chart);
            return fetch_data_chart;
        }
    }

    let fetch_data_factory = new FetchDataFactory();
    let fetch_data_chart_factory = new FetchDataChartFactory();

    $(document).ready(function(){
        for (aerobox of document.getElementsByClassName('aerobox-control-area')){
            let d = fetch_data_factory.create(aerobox.id, 'tf', '1', 'all');
        }
    });

    $('.dropdown-menu a').click(function(){
        $('#aeroboxDropDownBtn').text($(this).text());
        for (fetch_data of fetch_data_factory.list){
            if (fetch_data.w_id == this.id){
                fetch_data.fetch();
                data_(fetch_data.data);
                document.getElementById("aeroboxDropDownBtn").setAttribute("aerobox-attribute",this.id);
            }
        }
    });

    
    let fetch_d = fetch_data_factory.create(w_id,time_format,amount,variable,functionality);
    let fetch_chart = fetch_data_chart_factory.create(fetch_d, "#someDomId", "pm2_5");

    fetch_chart.dom_init();

    //window.setInterval(function(){refreshAll();},60000);
</script>